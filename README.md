# ElasticSearch
《ElasticSearch权威指南》读书笔记

### 基础入门 
1. 数据输入和输出
   1. 处理冲突
      1. 同时更新某条数据，如更新库存
         1. **悲观并发控制**：这种方法被关系型数据库广泛使用，它假定有变更冲突可能发生，因此阻塞访问资源以防止冲突。 一个典型的例子是读取一行数据之前先将其锁住，确保只有放置锁的线程能够对这行数据进行修改。
         2. **乐观并发控制**：Elasticsearch 中使用的这种方法假定冲突是不可能发生的，并且不会阻塞正在尝试的操作。 然而，如果源数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如何解决冲突。 例如，可以重试更新、使用新的数据、或者将相关情况报告给用户。
            1. Elasticsearch 是分布式的。当文档创建、更新或删除时， 新版本的文档必须复制到集群中的其他节点。Elasticsearch 也是异步和并发的，这意味着这些复制请求被并行发送，并且到达目的地时也许 顺序是乱的 。 Elasticsearch 需要一种方法确保文档的旧版本不会覆盖新的版本。每个文档都有一个 _version （版本）号，当文档被修改时版本号递增。 Elasticsearch 使用这个 _version 号来确保变更以正确顺序得到执行。如果旧版本的文档在新版本之后到达，它可以被简单的忽略。
            2. 我们可以利用 _version 号来确保 应用中相互冲突的变更不会导致数据丢失。 获取数据时拿到Version，更新是带上Version，若此时库中Version不同会提示更新失败并返回当前Version。
2. 分布式文档存储
   1. 路由一个文档到一个分片中
      1. 路由算法：`shard = hash(routing) % number_of_primary_shards` 。routing 是一个可变值，默认是文档的 _id ，也可以设置成一个自定义的值。
   2. 取回一个文档
      1. 当客户端通过ID查询一个文档时，接收到请求的Master节点计算出当前文档所在分片，把请求发送到对应节点，对应节点返回数据给Master，Master再返回给客户端
      2. 在处理读取请求时，协调结点在每次请求的时候都会通过轮询所有的副本分片来达到负载均衡。
      3. 在文档被检索时，已经被索引的文档可能已经存在于主分片上但是还没有复制到副本分片。 在这种情况下，副本分片可能会报告文档不存在，但是主分片可能成功返回文档。 一旦索引请求成功返回给用户，文档在主分片和副本分片都是可用的。
   3. 局部更新文档
      1. 客户端向协调节点发送修改请求，协调节点将请求转发到主分片所在节点，主节点更新成功后，将文档并行转发到副本重新建立索引，所有副本返回成功，则向协调节点返回成功，协调节点向客户端返回成功
      >当主分片把更改转发到副本分片时， 它不会转发更新请求。 相反，它转发完整文档的新版本。请记住，这些更改将会异步转发到副本分片，并且不能保证它们以发送它们相同的顺序到达。 如果Elasticsearch仅转发更改请求，则可能以错误的顺序应用更改，导致得到损坏的文档。 
3. 搜索-最基本的工具
   1. 分页过深性能差
   >理解为什么深度分页是有问题的，我们可以假设在一个有 5 个主分片的索引中搜索。 当我们请求结果的第一页（结果从 1 到 10 ），每一个分片产生前 10 的结果，并且返回给 协调节点 ，协调节点对 50 个结果排序得到全部结果的前 10 个。现在假设我们请求第 1000 页—​结果从 10001 到 10010 。所有都以相同的方式工作除了每个分片不得不产生前10010个结果以外。 然后协调节点对全部 50050 个结果排序最后丢弃掉这些结果中的 50040 个结果。可以看到，在分布式系统中，对结果排序的成本随分页的深度成指数上升。这就是 web 搜索引擎对任何查询都不要返回超过 1000 个结果的原因。
4. 执行分布式检索
   1. 当一个搜索请求被发送到某个节点时，这个节点就变成了协调节点。 这个节点的任务是广播查询请求到所有相关分片并将它们的响应整合成全局排序后的结果集合，这个结果集合会返回给客户端。
   2. 分片返回一个轻量级的结果列表到协调节点，它仅包含文档 ID 集合以及任何排序需要用到的值，例如 _score 。
   3. 协调节点确定那些文档需要返回后，像相关分片提交多个GET请求拿到需要数据，组合后返回给客户端
   4. 深分页：深分页非常耗费CPU、内存和宽带，正常人一般就查看签名两三页，很少翻页到几百页后
   5. 游标查询Scroll适合使用再深分页上。游标查询会取某个时间点的快照数据。 查询初始化之后索引上的任何变化会被它忽略。 它通过保存旧的数据文件来实现这个特性，结果就像保留初始化时的索引 视图 一样。
